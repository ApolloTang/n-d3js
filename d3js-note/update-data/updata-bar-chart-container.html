<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>D3: A bar chart that transitions to new data!</title>
    <script type="text/javascript" src="http://localhost:8001/js/lib/d3-3.4.13.js"></script>
    <script type="text/javascript" src="http://localhost:8001/js/lib/lodash-v2.4.1.js"></script>
    <script type="text/javascript" src="http://localhost:8001/js/lib/moment-v2.10.3.js"></script>
    <style type="text/css">
        /* No style rules here yet */
    </style>
</head>

<body>

    <p>Click on this text to update the chart with new data values.</p>

    <script type="text/javascript">

        var datasetFlatten = function(_incomming) {
            var out = [];
            var flatten = function(_incomming) {
                if (Object.prototype.toString.call(_incomming) === '[object Array]') {
                    var l = _incomming.length;
                    for (var i = 0; i < l; i++) {
                        flatten(_incomming[i]);
                    }
                } else {
                    out.push(_incomming)
                }
            }
            flatten(_incomming);
            return out;
        };

    var w = 300;
    var h = 250;

    var dataset = [
         { "date": "2015-07-14T00:00:00.000Z", "y": [10 , 100], "id": "212" }
        ,{ "date": "2015-07-15T00:00:00.000Z", "y": [20 , 90 ], "id": "213" }
        ,{ "date": "2015-07-16T00:00:00.000Z", "y": [30 , 80 ], "id": "214" }
        ,{ "date": "2015-07-17T00:00:00.000Z", "y": [40 , 70 ], "id": "215" }
        ,{ "date": "2015-07-18T00:00:00.000Z", "y": [50 , 60 ], "id": "216" }
        ,{ "date": "2015-07-19T00:00:00.000Z", "y": [60 , 50 ], "id": "217" }
        ,{ "date": "2015-07-20T00:00:00.000Z", "y": [70 , 40 ], "id": "218" }
        ,{ "date": "2015-07-21T00:00:00.000Z", "y": [80 , 30 ], "id": "219" }
        ,{ "date": "2015-07-22T00:00:00.000Z", "y": [90 , 20 ], "id": "220" }
        ,{ "date": "2015-07-23T00:00:00.000Z", "y": [100, 10 ], "id": "221" }
        // ,{ "date": "2015-07-24T00:00:00.000Z", "y": [ , 31], "id": "222" }
        // ,{ "date": "2015-07-25T00:00:00.000Z", "y": [ , 33], "id": "223" }
        // ,{ "date": "2015-07-26T00:00:00.000Z", "y": [ , 32], "id": "224" }
    ];

    var _dataset = _.map(dataset, function(item, index) {
       item.date = new Date(item.date);
       return item;
    });

    var barWidth = 4;
    var dates = _.map(_dataset, function(item, index){ return  item.date; });
    var dateMax = d3.max(dates);
    var dateMin = d3.min(dates);
    var dateScale = d3.time.scale().domain([dateMin, dateMax]).range([0+barWidth,w-barWidth]);

    var dataY_flatten = _.reduce(_dataset, function(accret, item, index){ accret.push(item.y[0]); accret.push(item.y[1]); return accret; }, []);
    var dataYmax = d3.max(dataY_flatten);
    var yScale = d3.scale.linear().domain([0, dataYmax]).range([0, h]);

        var index = 0;
        var svg = d3.select("body").append("svg").attr("width", w).attr("height", h);
        var points = svg.append("g").classed('points', true);

        var point =points.selectAll("g")
            .data(_dataset, function(d){ return d.date; })
            .enter()
            .append('g')
            .classed('point', true)
            .attr('data', function(d){return d.date})
            .attr('set', function(d){return 0})
            .each(function(d){console.log(d)});

        var pointContainer = point
        .attr('transform', function(d){
            var dataDate = d.date;
            var dataX = parseInt(dateScale(dataDate), 10);
            var x = dataX;
            return "translate("+x+",0"+")";
        })

        pointContainer
            .append('rect')
            .attr("x", 0)
            .attr("y", function(d) { return h - yScale(d.y[0]); })
            .attr("width", barWidth)
            .attr("height", function(d) { return yScale(d.y[0]); })
            .attr("fill", 'blue')


        var onClickCallback = function() {
            index = (index === 1) ? 0 : 1;

            var point = points.selectAll("g")
                .data(_dataset, function(d){ return d.date; })
                .classed('point', true)
                .attr('data', function(d){return d.date})
                .attr('set', function(d){return index})
                .each(function(d){console.log(d)});

            var pointContainer = point
                .attr('transform', function(d){
                    var dataDate = d.date;
                    var dataX = parseInt(dateScale(dataDate), 10);
                    var x = dataX;
                    return "translate("+x+",0"+")";
                })

            pointContainer.select('rect')
                .transition().duration(500)
                // .attr("x", 0)
                .attr("y", function(d) { return h - yScale(d.y[index]); })
                // .attr("width", 2)
                .attr("height", function(d) { return yScale(d.y[index]); })
                // .attr("fill", 'blue')

            pointContainer.exit().remove();
        };

        d3.select("p").on("click", onClickCallback )
    </script>
</body>

</html>
